ARG BASE_ALPINE
ARG BASE_GOLANG_18_BULLSEYE
FROM $BASE_GOLANG_18_BULLSEYE as artifact

RUN apt update && apt install -qfy \
  bash make git ca-certificates openssh-client openssl
RUN mkdir /prometheus-operator && cd /prometheus-operator \
  && git clone -b "v0.62.0" --single-branch https://github.com/prometheus-operator/prometheus-operator.git

WORKDIR /prometheus-operator/prometheus-operator
RUN go mod tidy && \
    make operator

FROM $BASE_ALPINE
COPY --from=artifact /prometheus-operator/prometheus-operator/operator /bin/operator
USER 65534
ENTRYPOINT ["/bin/operator"]
